## docker-apk-packager
apk-packager is a Docker image with an accompanying script to automate the process of building and packaging apk packages for x86_64, arm64 and armv7 from an x86_64 host. This project is currently under indefinite development, everything could be improved upon, but I am not a bashing sweat. So if you see something you can improve upon, even slightly open a PR, or if you find a bug/issue open an issue.

## Getting started
Download the script.

    wget https://raw.githubusercontent.com/hydazz/docker-apk-packager/main/package.sh

Allow the file to be executed

    chmod +x package.sh

Run the script. **(example, see below)**

    ./package.sh -a <arch> -k <key> -i <input> -o <output>

| Name | Description | Example |
|-|-|-|
| `-a` | **(Required)** The architecture that the builder will run on. Creating an apk file for that specific architecture. Supported Architectures: `amd64`, `arm64` and `armv7` | `amd64` |
| `-k` | **(Required)** The location of your private key generated by abuild-keygen | `/home/alex/key.rsa` |
| `-i` | **(Required)** The location of the APKBUILD file. | `/home/alex/smbclient/` **or** `/home/alex/smbclient/APKBUILD` |
| `-o` | **(Required)** The folder the .apk files will be saved to | `/home/alex/` |
| `-t` | **(Optional)** Set `true` to add the testing repo to the apk repository | `true` |

**Full paths are required. Do not use ~/ or ./**

Putting these all together in a command:

    ./package.sh -a amd64 -k /home/alex/key.rsa -i /home/alex/smbclient/ -o /home/alex/

If the build was successful you should see `>>> smbclient: Signing the index...` in the terminal. if you do not see this message, check the terminal for errors

### Building the same package for multiple architectures
I have not incorporated an easy way to do this in the scripts but running the commands separately doesn't hurt, here's an example to build for all supported architectures

    ./package.sh -a amd64 -k /home/alex/key.rsa -i /home/alex/smbclient/ -o /home/alex/
    ./package.sh -a arm64 -k /home/alex/key.rsa -i /home/alex/smbclient/ -o /home/alex/
    ./package.sh -a armv7 -k /home/alex/key.rsa -i /home/alex/smbclient/ -o /home/alex/

 This will create the `package` folder in the /home/alex directory. Depending on what architectures you used the folder should have seperate subfolders for each architecture: `aarch64`, `armv7` and `x86_64`.
### Building multiple packages for one or multiple architectures
This is a big no-no, the `APKINDEX.tar.gz` file will be overwritten, and everything will just become a mess. To get past this hurdle extract the `APKINDEX.tar.gz` archive, there will be an APKINDEX text file within the archive. Move this file somewhere safe and delete the `APKINDEX.tar.gz` archive from the directory. Then you can run the build command. Once the build command is done, follow these steps:

- Extract the newer `APKINDEX.tar.gz` (make sure its the new one, the only one should be deleted but whatever)
- Open the newer `APKINDEX` file that was extracted from the newer `APKINDEX.tar.gz`
- Copy the contents of the old `APKINDEX` file and paste them at the bottom of the new one. make sure there is 1 space between the packages

**Below is ran within an Alpine container**
- On an fresh Alpine Docker container mount the `package` folder within the container and run `apk add alpine-sdk`
- `cd` to the folder containing the modified `APKINDEX` file
- run `tar -c APKINDEX | abuild-tar --cut | gzip -9 >APKINDEX.tar.gz` to make a `APKINDEX.tar.gz` archive from the file
- Run `abuild-sign -k /path/to/private_key.rsa APKINDEX.tar.gz` to sign the index

Follow these steps for every package/architecture, it does get tedious
